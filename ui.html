<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Comments Collator</title>
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background: #f8f9fa;
        color: #333;
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      .status {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 14px;
      }
      
      .status.info {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
      }
      
      .status.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }
      
      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }
      
      .collate-button {
        width: 100%;
        padding: 12px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.2s ease;
      }
      
      .collate-button:hover:not(:disabled) {
        background: #1557b0;
      }
      
      .collate-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      
      .info-section {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .info-section h3 {
        margin: 0 0 12px 0;
        color: #1976d2;
        font-size: 16px;
      }
      
      .info-section p {
        margin: 8px 0;
        color: #1976d2;
        font-size: 14px;
        line-height: 1.4;
      }
      
      .info-help {
        margin-top: 12px;
        font-size: 12px;
      }
      
      .info-help summary {
        cursor: pointer;
        color: #1976d2;
        font-weight: 500;
        margin-bottom: 8px;
      }
      
      .info-help ul {
        margin: 8px 0 0 16px;
        color: #666;
      }
      
      .info-help li {
        margin: 4px 0;
        line-height: 1.3;
      }
      

      
      .collate-button.done {
        background: #4caf50;
      }
      
      .comments-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        min-height: 0;
      }
      
      .comment-item {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .comment-item:last-child {
        border-bottom: none;
      }
      
      .comment-text {
        font-size: 14px;
        line-height: 1.4;
        margin-bottom: 8px;
        color: #333;
      }
      
      .comment-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .comment-author {
        font-weight: 600;
      }
      
      .comment-timestamp {
        font-style: italic;
      }
      
      .no-comments {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-style: italic;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      

      
      .hidden {
        display: none;
      }
      
      /* Authentication Styles */
      .auth-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .auth-container h3 {
        margin: 0 0 12px 0;
        color: #495057;
        font-size: 16px;
      }
      
      .auth-options {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .primary-button {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .primary-button:hover {
        background: #1557b0;
      }
      
      .secondary-button {
        background: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
      }
      
      .secondary-button:hover {
        background: #5a6268;
      }
      
      .sync-button {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        margin-top: 8px;
      }
      
      .sync-button:hover {
        background: #218838;
      }
      
      .divider {
        text-align: center;
        color: #6c757d;
        font-size: 12px;
        position: relative;
      }
      
      .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #dee2e6;
        z-index: 1;
      }
      
      .divider::after {
        content: 'or';
        background: #f8f9fa;
        padding: 0 8px;
        position: relative;
        z-index: 2;
      }
      
      .token-input {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .token-input label {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
      }
      
      .token-input input {
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .token-input button {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .token-input button:hover {
        background: #138496;
      }
      
      .auth-help {
        margin-top: 16px;
        font-size: 12px;
        color: #6c757d;
      }
      
      .auth-help ol {
        margin: 8px 0 0 16px;
      }
      
      .auth-help li {
        margin: 4px 0;
        line-height: 1.3;
      }
      
      .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 12px;
        font-size: 14px;
      }
      
      .success-message {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 12px;
        font-size: 14px;
      }
      
      .user-info {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .user-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .auth-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
      }
      
      .auth-status p {
        margin: 0;
        font-size: 14px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div id="status" class="status info">
      Select a frame to view its comments
    </div>
    
        <!-- Info Section for Demo Mode -->
    <div id="demo-info" class="info-section">
      <h3>üîó Real Backend Integration</h3>
      <p>This plugin connects to a real backend server for authentic comment integration with webhooks, OAuth, and live data sync.</p>
      <div class="auth-status">
        <p id="connection-status">Backend: Not connected</p>
        <button id="connect-button" class="primary-button" onclick="showAuthSection()">Connect to Backend</button>
      </div>
    </div>

    <!-- Authentication Section -->
    <div id="auth-section" class="auth-container" style="display: none;">
      <h3>üîê Backend Authentication</h3>
      <p>Connect to the Comments Collator backend for real comment integration.</p>
      
      <div class="auth-form">
        <div class="auth-options">
          <button id="open-auth-btn" onclick="openAuthentication()" class="primary-button">
            üåê Authenticate with Figma
          </button>
          
          <div class="divider">or</div>
          
          <div class="token-input">
            <label for="session-token">Session Token:</label>
            <input type="password" id="session-token" placeholder="Paste session token from browser" />
            <button id="authenticate-btn" onclick="authenticateWithToken()">Connect</button>
          </div>
        </div>
      </div>
      
      <div class="auth-help">
        <p><strong>Authentication Steps:</strong></p>
        <ol>
          <li>Click "Authenticate with Figma" to open browser</li>
          <li>Complete OAuth flow in the browser</li>
          <li>Copy the session token from the success page</li>
          <li>Paste it in the field above and click "Connect"</li>
        </ol>
        <p><small>The backend server must be running on localhost:3000</small></p>
      </div>
      
      <div id="auth-error" class="error-message" style="display: none;"></div>
      <div id="auth-success" class="success-message" style="display: none;"></div>
    </div>

    <!-- User Info Section -->
    <div id="user-section" class="user-info" style="display: none;">
      <div class="user-details">
        <span id="user-name">Connected as: </span>
        <button id="logout-btn" onclick="logout()" class="secondary-button">Logout</button>
      </div>
      <button id="sync-btn" onclick="syncComments()" class="sync-button">üîÑ Sync Comments</button>
    </div>
    
    <button id="collate-button" class="collate-button" disabled>
      Collate Comments to Canvas
    </button>
    
    <div id="comments-container" class="comments-container hidden">
      <div id="comments-list"></div>
    </div>
    
    <div id="no-comments" class="no-comments hidden">
      No comments found on this frame
    </div>
    
    <script>
      let comments = [];
      let selectedFrameName = '';
      let isAuthenticated = false;
      let currentUser = null;
      
      // UI state management
      function showStatus(message, type = 'info') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type}`;
      }
      
      function updateAuthUI(authenticated, user = null) {
        isAuthenticated = authenticated;
        currentUser = user;
        
        const demoInfo = document.getElementById('demo-info');
        const authSection = document.getElementById('auth-section');
        const userSection = document.getElementById('user-section');
        const connectionStatus = document.getElementById('connection-status');
        
        if (authenticated && user) {
          // Show authenticated state
          demoInfo.style.display = 'none';
          authSection.style.display = 'none';
          userSection.style.display = 'block';
          
          document.getElementById('user-name').textContent = `Connected as: ${user.handle || user.name}`;
          showStatus('Connected to backend - showing real comments', 'success');
        } else {
          // Show unauthenticated state
          demoInfo.style.display = 'block';
          authSection.style.display = 'none';
          userSection.style.display = 'none';
          
          connectionStatus.textContent = 'Backend: Not connected (using demo data)';
          showStatus('Using demo data - connect to backend for real comments', 'info');
        }
      }
      
      function showAuthSection() {
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('demo-info').style.display = 'none';
      }
      
      function hideAuthMessages() {
        document.getElementById('auth-error').style.display = 'none';
        document.getElementById('auth-success').style.display = 'none';
      }
      
      function showAuthError(message) {
        const errorDiv = document.getElementById('auth-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('auth-success').style.display = 'none';
      }
      
      function showAuthSuccess(message) {
        const successDiv = document.getElementById('auth-success');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('auth-error').style.display = 'none';
      }
      
      function showComments(commentsData, frameName) {
        comments = commentsData;
        selectedFrameName = frameName;
        
        const container = document.getElementById('comments-container');
        const list = document.getElementById('comments-list');
        const noComments = document.getElementById('no-comments');
        const collateButton = document.getElementById('collate-button');
        
        if (comments.length === 0) {
          container.classList.add('hidden');
          noComments.classList.remove('hidden');
          collateButton.disabled = true;
          showStatus(`No comments found on "${frameName}"`, 'info');
        } else {
          container.classList.remove('hidden');
          noComments.classList.add('hidden');
          collateButton.disabled = false;
          
          const dataSource = isAuthenticated ? 'real backend data' : 'demo data';
          showStatus(`Found ${comments.length} comment(s) on "${frameName}" (${dataSource})`, 'success');
          
          // Clear and populate comments list
          list.innerHTML = '';
          comments.forEach(comment => {
            const item = document.createElement('div');
            item.className = 'comment-item';
            
            const resolvedBadge = comment.resolved ? 
              '<span style="color: #4caf50; font-weight: bold;">‚úì Resolved</span>' : 
              '<span style="color: #ff9800; font-weight: bold;">‚óã Active</span>';
            
            item.innerHTML = `
              <div class="comment-text">${escapeHtml(comment.text)}</div>
              <div class="comment-meta">
                <div>
                  <span class="comment-author">${escapeHtml(comment.author)}</span>
                  ${resolvedBadge}
                </div>
                <span class="comment-timestamp">${comment.timestamp}</span>
              </div>
            `;
            
            list.appendChild(item);
          });
        }
      }
      
      function hideComments() {
        document.getElementById('comments-container').classList.add('hidden');
        document.getElementById('no-comments').classList.add('hidden');
        document.getElementById('collate-button').disabled = true;
      }
      
      // Authentication functions
      function openAuthentication() {
        hideAuthMessages();
        parent.postMessage({ pluginMessage: { type: 'open-auth' } }, '*');
        showAuthSuccess('Browser window opened. Complete OAuth flow and copy the session token.');
      }
      
      function authenticateWithToken() {
        const token = document.getElementById('session-token').value.trim();
        
        if (!token) {
          showAuthError('Please enter a session token');
          return;
        }
        
        hideAuthMessages();
        showAuthSuccess('Authenticating...');
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'authenticate',
            token: token
          }
        }, '*');
      }
      
      function logout() {
        parent.postMessage({ pluginMessage: { type: 'logout' } }, '*');
        updateAuthUI(false);
        document.getElementById('session-token').value = '';
      }
      
      function syncComments() {
        if (!isAuthenticated) {
          showStatus('Authentication required to sync comments', 'error');
          return;
        }
        
        showStatus('Syncing comments from backend...', 'info');
        parent.postMessage({ pluginMessage: { type: 'sync-comments' } }, '*');
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Message handling from plugin
      window.onmessage = (event) => {
        const { type } = event.data.pluginMessage;
        
        if (type === 'init') {
          const data = event.data.pluginMessage.data;
          showStatus(`Connected to file: ${data.fileName}`, 'info');
          // Don't update auth UI here - wait for auto-session check
        } else if (type === 'auto-connected') {
          const user = event.data.pluginMessage.user;
          const message = event.data.pluginMessage.message;
          updateAuthUI(true, user);
          showStatus(`${message} as ${user.handle || user.name}`, 'success');
        } else if (type === 'show-auth-screen') {
          updateAuthUI(false);
          showStatus('Connect to backend for real comment integration', 'info');
        } else if (type === 'comments-data') {
          const { comments: commentsData, frameName } = event.data.pluginMessage;
          showComments(commentsData, frameName);
        } else if (type === 'no-selection') {
          hideComments();
          showStatus('Select a frame to view its comments', 'info');
        } else if (type === 'not-frame') {
          hideComments();
          showStatus('Please select a frame (not a component or other element)', 'warning');
        } else if (type === 'no-comments') {
          hideComments();
          showStatus('No comments found on this frame', 'info');
        } else if (type === 'auth-success') {
          const user = event.data.pluginMessage.user;
          updateAuthUI(true, user);
          showAuthSuccess(`Successfully connected as ${user.handle || user.name}`);
          document.getElementById('session-token').value = '';
        } else if (type === 'auth-error') {
          showAuthError(event.data.pluginMessage.message);
          updateAuthUI(false);
        } else if (type === 'logged-out') {
          updateAuthUI(false);
          showStatus('Logged out - using demo data', 'info');
        } else if (type === 'sync-success') {
          showStatus(event.data.pluginMessage.message, 'success');
        } else if (type === 'sync-error') {
          showStatus(event.data.pluginMessage.message, 'error');
        } else if (type === 'open-url') {
          // Plugin requested to open URL (for OAuth flow)
          console.log('Open URL:', event.data.pluginMessage.url);
          showAuthSuccess('Browser authentication started. Check browser window.');
        } else if (type === 'error') {
          showStatus(event.data.pluginMessage.message, 'error');
        }
      };
      
      // Button handlers
      function collateComments() {
        if (comments.length > 0) {
          parent.postMessage({ pluginMessage: { type: 'collate-comments' } }, '*');
        }
      }
      
      // Setup event listeners
      document.getElementById('collate-button').addEventListener('click', collateComments);
      
      // Allow Enter key to submit token
      document.getElementById('session-token').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          authenticateWithToken();
        }
      });
    </script>
  </body>
</html> 